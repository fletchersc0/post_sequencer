<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Truth Judgment Task (Complete Statement Set)</title>

  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --input-bg: #1a1a1a;
      --border-color:#444;
      --warning-color: #ff4d4d;
    }
    *      { box-sizing:border-box; }
    html,body{
      margin:0;
      font-family:system-ui,sans-serif;
      background:var(--bg);
      color:var(--fg);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      text-align:center;
    }
    #stage{
      width:92%;
      max-width:860px;
      padding:2rem;
    }
    button,
    input[type=text],
    input[type=number],
    select {
      font-size:1rem;
      padding:.5rem 1rem;
      margin:.3rem;
      background:var(--input-bg);
      color:var(--fg);
      border:1px solid var(--border-color);
    }
    button{
      cursor:pointer;
      background:#222;
    }
    button:hover{
      background:#333;
      border-color:#555;
    }
    .fixation-cross-container{
      font-size:3rem;
      height:6em; 
      display:flex;align-items:center;justify-content:center;
    }
    .stimulus-container, .message-container, .questionnaire-container, .info-container {
      min-height:12em; 
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      padding: 1em;
    }
    .info-container {
      text-align: left;
      max-width: 680px;
      margin: auto;
      line-height: 1.6;
    }
    .info-container h2 { text-align: center; }
    .info-container .button-container {
      text-align: center;
      width: 100%;
      margin-top: 2em;
    }
    .stimulus-text { 
      font-size: 1.8rem; 
      line-height: 1.4;
      margin-bottom: 1em;
      max-width: 90%; 
    }
    .instructions-text, .message-text, .question-text { 
      font-size:1.1rem; 
      line-height:1.6; 
      margin-bottom:1em;
    }
    .key-reminder { 
      font-size:1rem; 
      color: #ccc; 
      margin-top: 1em;
      width: 100%;
      overflow: hidden;
    }
    .loading, .error-text { font-size:1.2rem; color: #aaa; }
    .input-label { display: block; margin-top: 1em; margin-bottom: 0.2em; }
    .warning-message {
      color: var(--warning-color);
      font-weight: bold;
      font-size: 1.2rem;
      margin: 1em 0;
    }
    /* Styles for Debriefing Screen, adapted from the first example */
    .debrief-content {
      height: 300px;
      overflow-y: scroll;
      border: 1px solid var(--border-color);
      padding: 1rem;
      text-align: left;
      margin-bottom: 1rem;
      background: var(--input-bg);
    }
    .button-bar { margin-top: 1.5rem; text-align: center; }
  </style>
</head>
<body>
  <div id="stage">Loading experiment...</div>

<script>
// -------------------- CONFIG --------------------
const CONFIG = {
  experimentName         : 'Political Truth Judgment Task (Complete Statement Set)',
  csvFile                : 'stimulus_master.csv', 
  responseKeys           : { 
    true_key: null,
    false_key: null,
  },
  dataPipeID             : 'qWHxwr6D720q', 
  fallbackDownload       : true, 
  
  // ★ ADDED: Prolific URL for completion link
  prolificURL            : 'https://app.prolific.co/submissions/complete?cc=YOUR_CODE_HERE', // <-- ❗REPLACE with your actual Prolific completion code

  fixationCrossDuration  : 500,
  statementTimeoutDuration: 15000,
  itiMinDuration         : 500,
  itiMaxDuration         : 1000,
  
  numPracticeTrials      : 4,
  trialsPerBreak         : 16,

  headlineTypes          : ['Clickbait', 'Not Clickbait'],
  truthValues            : ['True', 'False'], 
  congruenceLevels       : ['Congruent', 'Incongruent'],

  practiceTrials         : [
    { statement_id: 'practice_fact_1', statement_text: 'Water freezes at 0 degrees Celsius at standard atmospheric pressure.', headline_type: 'Not Clickbait', truth_value: true, partisan_alignment: 'Neutral', is_practice_stimulus: true, is_attention_check: false, partisan_congruence: 'Neutral' },
    { statement_id: 'practice_fact_2', statement_text: 'The Earth orbits around the Sun, completing one orbit approximately every 365 days.', headline_type: 'Not Clickbait', truth_value: true, partisan_alignment: 'Neutral', is_practice_stimulus: true, is_attention_check: false, partisan_congruence: 'Neutral' },
    { statement_id: 'practice_myth_1', statement_text: 'Humans only use 10% of their brains in daily life.', headline_type: 'Clickbait', truth_value: false, partisan_alignment: 'Neutral', is_practice_stimulus: true, is_attention_check: false, partisan_congruence: 'Neutral' },
    { statement_id: 'practice_myth_2', statement_text: 'The Great Wall of China is the only human-made structure visible from the Moon with the naked eye.', headline_type: 'Clickbait', truth_value: false, partisan_alignment: 'Neutral', is_practice_stimulus: true, is_attention_check: false, partisan_congruence: 'Neutral' }
  ],

  masterHeader : [ 
    'prolific_id', 'political_orientation', 'participant_headline_type', 'key_assignment',
    'trial_number_overall', 'block_type', 'trial_number_in_block',
    'statement_id', 'statement_text', 
    'headline_type', 'truth_value_stimulus', 'partisan_alignment_stimulus', 'partisan_congruence',
    'is_practice_trial', 'is_attention_check',
    'response', 'accuracy', 'rt_ms',
    'avg_favorability', 'age', 'gender', 'education', 'timestamp'
  ]
};

// ------------------------ STATE OBJECT ------------------------
const state = {
  prolificID              : '',
  politicalOrientation    : '',
  participantHeadlineType : '',
  keyAssignment           : '',
  age                     : null,
  gender                  : '',
  education               : '',
  allStimuli              : [], 
  practiceStimuli         : [], 
  mainExperimentStimuli   : [],
  data                    : [],
  trialCountOverall       : 0,
  currentBlock            : '',
  currentTrialInBlock     : 0,
  totalMainTrials         : 0,
};

const stage = document.getElementById('stage');
let rtClock = 0;

function assignResponseKeys() {
  const qIsTrue = Math.random() < 0.5;
  if (qIsTrue) {
    CONFIG.responseKeys.true_key = 'q';
    CONFIG.responseKeys.false_key = 'p';
    state.keyAssignment = 'q=true_p=false';
  } else {
    CONFIG.responseKeys.true_key = 'p';
    CONFIG.responseKeys.false_key = 'q';
    state.keyAssignment = 'p=true_q=false';
  }
}
assignResponseKeys();

// ------------------------ UTILITY FUNCTIONS ------------------------
const sleep = ms => new Promise(r => setTimeout(r, ms));
const shuffle = arr => { for(let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } return arr; };
const show = html => stage.innerHTML = html;
const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

function getKeyReminderHTML() {
  return `<p class="key-reminder">
    <span style="float:left; width:45%; text-align:left;">Q = ${CONFIG.responseKeys.true_key === 'q' ? 'TRUE' : 'FALSE'}</span>
    <span style="float:right; width:45%; text-align:right;">P = ${CONFIG.responseKeys.true_key === 'p' ? 'TRUE' : 'FALSE'}</span>
  </p>`;
}

// ------------------------ DATA LOGGING FUNCTIONS ------------------------
function log(dataRow) {
  dataRow.timestamp = new Date().toISOString();
  dataRow.key_assignment = state.keyAssignment;
  dataRow.age = state.age;
  dataRow.gender = state.gender;
  dataRow.education = state.education;
  
  const completeRow = {};
  CONFIG.masterHeader.forEach(header => {
    completeRow[header] = (header in dataRow) ? dataRow[header] : '';
  });
  state.data.push(completeRow);
}

function toCSV(rows){
  if (!rows.length) return '';
  const header = CONFIG.masterHeader;
  const lines  = [header.join(',')];
  rows.forEach(r => {
    const line = header.map(k => {
      let cell = (k in r && r[k] !== null && r[k] !== undefined) ? r[k] : '';
      cell = String(cell);
      if (/[",\n\r]/.test(cell)) cell = '"' + cell.replace(/"/g, '""') + '"';
      return cell;
    }).join(',');
    lines.push(line);
  });
  return lines.join('\n');
}

function uploadCSV(filename, csvData){
  if (!CONFIG.dataPipeID) return Promise.resolve({ok: false, statusText: "DataPipeID not set"});
  return fetch('https://pipe.jspsych.org/api/data', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ experimentID: CONFIG.dataPipeID, filename: filename, data: csvData })
  });
}

function downloadCSV(csvData, filename){
  const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ------------------- ★ NEW/MODIFIED FUNCTIONS FOR SCREENING & DEBRIEF -------------------

// ★ NEW: Function to handle automatic redirection for ineligible participants
function exitToProlific() {
  const message = `
    <div class="message-container" style="text-align:center;">
      <h2>Thank you for your interest.</h2>
      <p>As you do not meet the eligibility criteria or do not wish to consent, you cannot proceed with the study.</p>
      <p>You will now be returned to Prolific.</p>
    </div>
  `;
  show(message);
  setTimeout(() => {
    window.location.href = 'https://app.prolific.com';
  }, 5000); // 5-second delay
}

// ------------------- INFORMATION & CONSENT SCREEN (★ MODIFIED) -------------------
async function showInformationAndConsent() {
  const participantInfoHTML = `
    <h2>Participant Information Sheet</h2>
    <p>You are invited to take part in a research study...</p>
    <!-- ... (rest of your information sheet text) ... -->
  `;
  
  show(`<div class="info-container">${participantInfoHTML}<div class="button-container"><button id="next_btn">Next</button></div></div>`);
  await new Promise(resolve => { document.getElementById('next_btn').onclick = resolve; });

  // ★ This is the only function that needs to be modified for the screening logic
  async function askYesNoQuestion(questionText) {
      show(`
          <div class="questionnaire-container">
              <p class="question-text">${questionText}</p>
              <button id="yes_btn">Yes</button> <button id="no_btn">No</button>
          </div>
      `);
      return new Promise(resolve => {
          document.getElementById('yes_btn').onclick = () => resolve(true);
          document.getElementById('no_btn').onclick = () => resolve(false);
      });
  }

  // Age verification
  const isOver18 = await askYesNoQuestion('Are you over 18 years of age?');
  if (!isOver18) {
    exitToProlific();
    return new Promise(() => {}); // Halts execution
  }

  // Consent confirmation
  const hasConsented = await askYesNoQuestion('Do you consent to participate in the study?');
  if (!hasConsented) {
    exitToProlific();
    return new Promise(() => {}); // Halts execution
  }

  return true; // Consent given, continue experiment
}

// ------------------- STIMULUS LOADER -------------------
async function loadCSVStimuli(){
  const response = await fetch(CONFIG.csvFile);
  if (!response.ok) throw new Error(`Failed to load ${CONFIG.csvFile}: ${response.statusText}`);
  const txt = await response.text();
  let lines = txt.trim().split(/\r?\n/);
  
  let delimiter = ",";
  if (lines.length > 0 && lines[0].includes("\t") && lines[0].split("\t").length > lines[0].split(",").length) {
      delimiter = "\t";
  }

  const headerLine = lines.shift();
  const header = headerLine.split(delimiter).map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
  
  const expectedCsvHeaders = ['item', 'claim', 'clickbait', 'veracity', 'favorability'];
  for (const reqHeader of expectedCsvHeaders) {
      if (!header.includes(reqHeader)) {
          throw new Error(`CSV file is missing required header: '${reqHeader}'.`);
      }
  }
  
  lines.forEach((line) => {
    if (line.trim() === "") return; 

    let fields = [];
    if (delimiter === ",") {
        let current = '', inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"' && (i === 0 || line[i-1] !== '\\')) inQuotes = !inQuotes;
            else if (char === delimiter && !inQuotes) { fields.push(current.trim().replace(/^"|"$/g, '')); current = ''; }
            else current += char;
        }
        fields.push(current.trim().replace(/^"|"$/g, ''));
    } else { 
        fields = line.split(delimiter).map(f => f.trim().replace(/^"|"$/g, ''));
    }

    const rawStim = {};
    header.forEach((h, i) => rawStim[h] = (fields[i] !== undefined ? fields[i] : '').trim());

    const itemNum = rawStim.item;
    if (!itemNum) return;

    const truthValue = rawStim.veracity.toUpperCase() === 'TRUE';
    let partisanAlignment = 'Neutral';
    if (rawStim.favorability.toLowerCase() === 'republican') partisanAlignment = 'Right';
    else if (rawStim.favorability.toLowerCase() === 'democrat') partisanAlignment = 'Left';

    const avgFavorability = rawStim.avg_favorability || '';

    if (rawStim.clickbait) state.allStimuli.push({ statement_id: `item${itemNum}_clickbait`, statement_text: rawStim.clickbait, headline_type: 'Clickbait', truth_value: truthValue, partisan_alignment: partisanAlignment, avg_favorability: avgFavorability, is_practice_stimulus: false, is_attention_check: false });
    if (rawStim.claim) state.allStimuli.push({ statement_id: `item${itemNum}_notclickbait`, statement_text: rawStim.claim, headline_type: 'Not Clickbait', truth_value: truthValue, partisan_alignment: partisanAlignment, avg_favorability: avgFavorability, is_practice_stimulus: false, is_attention_check: false });
  });
}

// ------------------- KEYBOARD HELPERS -------------------
function waitKeys(validKeys) {
  return new Promise(resolve => {
    function onKey(e) {
      const key = e.key.toLowerCase();
      if (validKeys.includes(key)) {
        document.removeEventListener('keydown', onKey);
        resolve(key);
      }
    }
    document.addEventListener('keydown', onKey);
  });
}

function waitKeysOrTimeout(validKeys, timeoutMs) {
  return new Promise(resolve => {
    let timeoutId = null;
    function onKey(e) {
      const key = e.key.toLowerCase();
      if (validKeys.includes(key)) {
        if (timeoutId) clearTimeout(timeoutId);
        document.removeEventListener('keydown', onKey);
        resolve({ key: key, timedOut: false });
      }
    }
    document.addEventListener('keydown', onKey);
    timeoutId = setTimeout(() => {
      document.removeEventListener('keydown', onKey);
      resolve({ key: null, timedOut: true });
    }, timeoutMs);
  });
}

// ------------------- STIMULUS PREPARATION -------------------
function prepareExperimentTrials() {
    if (state.allStimuli.length === 0) throw new Error("No stimuli loaded.");
    if (!state.participantHeadlineType) throw new Error("Headline type not assigned.");
    
    state.practiceStimuli = shuffle([...CONFIG.practiceTrials]);
    
    const headlineTypeFilteredStimuli = state.allStimuli.filter(
        stim => stim.headline_type === state.participantHeadlineType
    );
    if (headlineTypeFilteredStimuli.length === 0) throw new Error(`No stimuli found for assigned headline type.`);
    
    state.mainExperimentStimuli = headlineTypeFilteredStimuli.map(stim => {
        let congruence;
        if (stim.partisan_alignment === 'Neutral') congruence = Math.random() < 0.5 ? 'Congruent' : 'Incongruent';
        else if (state.politicalOrientation === 'Left-leaning') congruence = stim.partisan_alignment === 'Left' ? 'Congruent' : 'Incongruent';
        else if (state.politicalOrientation === 'Right-leaning') congruence = stim.partisan_alignment === 'Right' ? 'Congruent' : 'Incongruent';
        else congruence = 'ErrorCongruence';
        return {...stim, partisan_congruence: congruence};
    });
    
    shuffle(state.mainExperimentStimuli);
    state.totalMainTrials = state.mainExperimentStimuli.length;
}

// ------------------- INTRO & DEMOGRAPHICS -------------------
async function introScreen(){
  show(`
    <div class="message-container">
      <h1>${CONFIG.experimentName}</h1>
      <p class="instructions-text">Welcome! In this study, you will be shown a series of statements. For each statement, please indicate whether you believe it is TRUE or FALSE.</p>
      <label class="input-label" for="prolificID">Please enter your Prolific ID:</label>
      <input type="text" id="prolificID" placeholder="Prolific ID" />
      <br><br>
      <button id="startBtn">Continue</button>
    </div>
  `);

  return new Promise(resolve => {
    document.getElementById('startBtn').onclick = () => {
      const pid = document.getElementById('prolificID').value.trim();
      if (!pid) { alert('Please enter your Prolific ID.'); return; }
      state.prolificID = pid;
      resolve();
    };
  });
}

async function runDemographics() {
  show(`<div class="questionnaire-container"><p class="question-text">Please enter your age:</p><input type="number" id="age_input" min="18" max="120" /><button id="next_btn">Next</button></div>`);
  await new Promise(resolve => {
    document.getElementById('next_btn').onclick = () => {
      const age = parseInt(document.getElementById('age_input').value);
      if (!age || age < 18) { alert('Please enter a valid age (18+).'); return; }
      state.age = age; resolve();
    };
  });
  
  show(`<div class="questionnaire-container"><p class="question-text">Please select your gender:</p><select id="gender_select"><option value="" disabled selected>Select...</option><option value="male">Male</option><option value="female">Female</option><option value="non-binary">Non-binary</option><option value="prefer-not-to-say">Prefer not to say</option></select><button id="next_btn">Next</button></div>`);
  await new Promise(resolve => {
    document.getElementById('next_btn').onclick = () => {
      const gender = document.getElementById('gender_select').value;
      if (!gender) { alert('Please select an option.'); return; }
      state.gender = gender; resolve();
    };
  });
  
  show(`<div class="questionnaire-container"><p class="question-text">What is your highest level of education?</p><select id="education_select"><option value="" disabled selected>Select...</option><option value="no-highschool">Did not complete highschool</option><option value="highschool">Year 12 or equivalent</option><option value="diploma">Diploma or equivalent</option><option value="bachelors">Bachelor's degree</option><option value="postgrad">Post-graduate degree</option></select><button id="next_btn">Next</button></div>`);
  await new Promise(resolve => {
    document.getElementById('next_btn').onclick = () => {
      const edu = document.getElementById('education_select').value;
      if (!edu) { alert('Please select an option.'); return; }
      state.education = edu; resolve();
    };
  });
  
  show(`<div class="questionnaire-container"><p class="question-text">Please select your political orientation:</p><select id="political_select"><option value="" disabled selected>Select...</option><option value="Left-leaning">Left-leaning</option><option value="Right-leaning">Right-leaning</option></select><button id="next_btn">Next</button></div>`);
  await new Promise(resolve => {
    document.getElementById('next_btn').onclick = () => {
      const pol = document.getElementById('political_select').value;
      if (!pol) { alert('Please select an option.'); return; }
      state.politicalOrientation = pol; resolve();
    };
  });
  
  state.participantHeadlineType = Math.random() < 0.5 ? 'Clickbait' : 'Not Clickbait';
}

// ------------------- INSTRUCTIONS & TRIAL LOGIC -------------------
async function showInstructionsScreen() {
    show(`
        <div class="message-container">
            <h2>Instructions</h2>
            <p class="instructions-text">You will first see a fixation cross (+). Then, a statement will appear.<br>Your task is to decide if the statement is TRUE or FALSE using the Q and P keys.<br>${getKeyReminderHTML()}<br>Please respond as quickly and accurately as you can.<br>There will be a short practice session first.</p>
            <button id="startPracticeBtn">Start Practice</button>
        </div>
    `);
    return new Promise(resolve => { document.getElementById('startPracticeBtn').onclick = resolve; });
}

async function runSingleTrial(stimulus, isPracticeTrial = false) {
  state.trialCountOverall++;
  state.currentTrialInBlock++;

  show(`<div class="fixation-cross-container">+</div>`);
  await sleep(CONFIG.fixationCrossDuration);

  show(`<div class="stimulus-container"><p class="stimulus-text">${stimulus.statement_text}</p>${getKeyReminderHTML()}</div>`);
  rtClock = performance.now();

  const responseResult = await waitKeysOrTimeout([CONFIG.responseKeys.true_key, CONFIG.responseKeys.false_key], CONFIG.statementTimeoutDuration);
  const rt = responseResult.timedOut ? CONFIG.statementTimeoutDuration : Math.round(performance.now() - rtClock);
  
  let participantResponse = null, accuracy = null;
  if (responseResult.timedOut) {
    participantResponse = 'TIMEOUT';
    show(`<div class="message-container"><h3 class="warning-message">Time's Up!</h3><p>Please respond faster. Press SPACE to continue.</p></div>`);
    await waitKeys([' ']);
  } else {
    participantResponse = responseResult.key === CONFIG.responseKeys.true_key ? 'True' : 'False';
    accuracy = (participantResponse === 'True') === stimulus.truth_value ? 1 : 0;
  }

  log({
    prolific_id: state.prolificID, political_orientation: state.politicalOrientation,
    participant_headline_type: state.participantHeadlineType, trial_number_overall: state.trialCountOverall,
    block_type: state.currentBlock, trial_number_in_block: state.currentTrialInBlock,
    statement_id: stimulus.statement_id, statement_text: stimulus.statement_text, 
    headline_type: isPracticeTrial ? 'Practice' : stimulus.headline_type,
    truth_value_stimulus: stimulus.truth_value ? 'TRUE' : 'FALSE', 
    partisan_alignment_stimulus: stimulus.partisan_alignment,
    partisan_congruence: stimulus.partisan_congruence || 'N/A', 
    is_practice_trial: isPracticeTrial ? 1 : 0, is_attention_check: stimulus.is_attention_check ? 1 : 0, 
    response: participantResponse, accuracy: accuracy, rt_ms: rt,
    avg_favorability: stimulus.avg_favorability || '',
  });

  show(''); 
  await sleep(getRandomInt(CONFIG.itiMinDuration, CONFIG.itiMaxDuration));
}

// ------------------- BLOCKS & EXPERIMENT FLOW -------------------
async function runPracticeBlock() {
    state.currentBlock = 'Practice';
    state.currentTrialInBlock = 0;
    show(`<div class="message-container"><h2>Practice Round</h2><p>Press SPACE to begin.</p></div>`);
    await waitKeys([' ']);
    for (const stimulus of state.practiceStimuli) {
        await runSingleTrial(stimulus, true);
    }
    show(`<div class="message-container"><h2>End of Practice</h2><p>The main experiment will now begin.</p><button id="startMainBtn">Start Main Experiment</button></div>`);
    return new Promise(resolve => { document.getElementById('startMainBtn').onclick = resolve; });
}

async function runMainExperimentBlock() {
    state.currentBlock = 'MainExperiment';
    state.currentTrialInBlock = 0;
    show(`<div class="message-container"><h2>Main Experiment</h2><p>Press SPACE to begin.</p></div>`);
    await waitKeys([' ']);
    for (let i = 0; i < state.mainExperimentStimuli.length; i++) {
        await runSingleTrial(state.mainExperimentStimuli[i], false);
        if ((i + 1) < state.mainExperimentStimuli.length && (i + 1) % CONFIG.trialsPerBreak === 0) {
            show(`<div class="message-container"><h2>Break Time!</h2><p>Press SPACE when ready to continue.</p></div>`);
            await waitKeys([' ']);
        }
    }
}

// ------------------- DEBRIEFING & FINISH (★ MODIFIED) -------------------
async function showDebriefingAndFinish(uploadSuccess = true) {
  const debriefFile = state.participantHeadlineType === 'Clickbait' ? 'debrief_clickbait.txt' : 'debrief_headline.txt';
  let debriefHTML = `<p>Thank you for your participation.</p>`; // Fallback
  
  try {
    const response = await fetch(debriefFile);
    if (response.ok) debriefHTML = await response.text();
  } catch (e) {
    console.error("Could not load debrief file:", e);
  }

  let message = '';
  if (uploadSuccess) {
    message = `<p><strong>Your data has been successfully uploaded.</strong></p>
               <p>Please click the arrow below to complete the study and return to Prolific.</p>`;
  } else {
    message = `<h2>Network error – data downloaded locally.</h2>
               <p style="text-align:center;">There was an issue uploading your data. A file has been downloaded to your computer instead.</p>
               <p style="text-align:center;">Please email this file to the researcher, then click the arrow to return to Prolific.</p>`;
  }

  const finalScreenHTML = `
    <div class="questionnaire-container">
      <h1>Debriefing Information</h1>
      <div class="debrief-content">${debriefHTML}</div>
      ${message}
      <div class="button-bar">
        <a href="${CONFIG.prolificURL}" style="font-size: 2.5rem; text-decoration: none; color: var(--fg);">&rarr;</a>
      </div>
    </div>`;
  
  show(finalScreenHTML);
}

async function finishExperiment(){ 
  const csv = toCSV(state.data);
  const filename = `${CONFIG.experimentName.replace(/\s+/g, '_')}_${state.prolificID}.csv`;
  
  show('<div class="message-container"><h2>Uploading your data…</h2><p>Please wait.</p></div>');
  
  try {
    const response = await uploadCSV(filename, csv);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    await showDebriefingAndFinish(true);
  } catch (err) {
    console.error('Data upload failed:', err);
    if (CONFIG.fallbackDownload) {
      downloadCSV(csv, filename);
    }
    await showDebriefingAndFinish(false);
  }
}

// ------------------- LAUNCH (★ MODIFIED) -------------------
(async () => {
  try {
    show('<h2>Loading...</h2>');
    await loadCSVStimuli(); 
    
    // ★ This function now handles the entire PIS/Consent/Screening flow
    await showInformationAndConsent();
    
    // If screening is passed, the script will continue from here
    await introScreen();
    await runDemographics();
    prepareExperimentTrials();
    await showInstructionsScreen();
    await runPracticeBlock();
    await runMainExperimentBlock();
    await finishExperiment();

  } catch (e) {
    console.error("Experiment Error:", e);
    stage.innerHTML = `<div class="message-container"><h2 style="color:red;">An Error Occurred</h2><p><b>Error:</b> ${e.message}</p><p>Please contact the researcher.</p></div>`;
  }
})();
</script>
</body>
</html>
